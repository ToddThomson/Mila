name: Mila CI Pipeline

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master

env:
  CUDA_VERSION: '13.0.2'

jobs:
  build:
    name: Build Mila
    runs-on: ubuntu-24.04
    container: nvidia/cuda:13.0.2-cudnn-devel-ubuntu24.04
    env:
      CUDA_PATH: /usr/local/cuda-13.0
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - uses: actions/checkout@v4

      - name: Restore build cache and ccache
        uses: actions/cache@v4
        with:
          path: |
            .ccache
            build
            .cache/cmake
          key: ${{ runner.os }}-mila-${{ env.CUDA_VERSION }}-build-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-mila-build-

      - name: Install host toolchain and tools
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential \
            git \
            wget \
            curl \
            software-properties-common \
            ca-certificates \
            gnupg2 \
            lsb-release \
            gdb \
            gcc-14 g++-14 \
            ninja-build \
            ccache
          # Install LLVM/Clang 19 using official script
          wget -q https://apt.llvm.org/llvm.sh -O /tmp/llvm.sh
          chmod +x /tmp/llvm.sh
          /tmp/llvm.sh 19
          rm -f /tmp/llvm.sh
          # Configure alternatives
          update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 140 || true
          update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 140 || true
          update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100 || true
          update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100 || true
          git --version
          gcc --version
          clang++ --version
          ccache --version

      - name: Install CMake 3.31.7
        run: |
          wget -q https://github.com/Kitware/CMake/releases/download/v3.31.7/cmake-3.31.7-linux-x86_64.tar.gz
          tar -xzf cmake-3.31.7-linux-x86_64.tar.gz
          cp -r cmake-3.31.7-linux-x86_64/bin/* /usr/local/bin/
          cp -r cmake-3.31.7-linux-x86_64/share/* /usr/local/share/
          cmake --version

      - name: Verify CUDA toolchain
        run: |
          echo "CUDA_PATH=${CUDA_PATH}"
          ls -la $CUDA_PATH/bin || true
          nvcc --version || true

      - name: Install dependencies (miniz)
        run: |
          git clone https://github.com/richgel999/miniz.git /tmp/miniz
          cmake -B /tmp/miniz/build -S /tmp/miniz -G Ninja
          cmake --build /tmp/miniz/build --config Release
          cmake --install /tmp/miniz/build

      - name: Ensure GoogleTest available
        run: |
          apt-get update
          apt-get install -y --no-install-recommends libgtest-dev cmake
          if [ -d /usr/src/googletest ]; then
            cmake -S /usr/src/googletest -B /tmp/gtest-build -DCMAKE_BUILD_TYPE=Release
            cmake --build /tmp/gtest-build --target install
          fi

      - name: Configure CMake (Ninja)
        env:
          CC: clang-19
          CXX: clang++-19
        run: |
          mkdir -p build
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang-19 \
            -DCMAKE_CXX_COMPILER=clang++-19 \
            -DCMAKE_CUDA_COMPILER=${CUDA_PATH}/bin/nvcc \
            -DCUDAToolkit_ROOT=${CUDA_PATH} \
            -DCMAKE_CUDA_FLAGS="--allow-unsupported-compiler -ccbin=gcc-14" \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_CXX_STANDARD_REQUIRED=ON \
            -DCMAKE_CXX_EXTENSIONS=OFF \
            -DMILA_ENABLE_TESTING=ON

      - name: Build Mila
        run: cmake --build build --config Release -- -j $(nproc)

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mila-build
          path: |
            build/
            !build/.ccache
          retention-days: 1

  test:
    name: Run Tests
    needs: build
    runs-on: ubuntu-24.04
    container: nvidia/cuda:13.0.2-cudnn-devel-ubuntu24.04
    env:
      CUDA_PATH: /usr/local/cuda-13.0

    steps:
      - uses: actions/checkout@v4

      - name: Install runtime dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            libgtest-dev

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: mila-build
          path: build

      - name: Run unit tests
        run: |
          cd build
          chmod +x $(find . -type f -executable)
          ctest --output-on-failure --verbose -j $(nproc)

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/Testing/

  docs:
    name: Generate Documentation
    needs: build
    runs-on: ubuntu-24.04
    if: success()

    steps:
      - uses: actions/checkout@v4

      - name: Install documentation tools
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            doxygen \
            graphviz

      - name: Install CMake 3.31.7
        run: |
          wget -q https://github.com/Kitware/CMake/releases/download/v3.31.7/cmake-3.31.7-linux-x86_64.tar.gz
          tar -xzf cmake-3.31.7-linux-x86_64.tar.gz
          cp -r cmake-3.31.7-linux-x86_64/bin/* /usr/local/bin/
          cp -r cmake-3.31.7-linux-x86_64/share/* /usr/local/share/

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: mila-build
          path: build

      - name: Generate documentation
        run: cmake --build build --target docs

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: build/docs/html

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ${{ github.workspace }}/build/docs/html
          branch: gh-pages