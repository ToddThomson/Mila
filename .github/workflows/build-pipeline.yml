name: Mila CI Pipeline

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master

env:
  CUDA_VERSION: '13.0.2'

jobs:
  build-test-docs:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Cache build and ccache
        uses: actions/cache@v4
        with:
          path: |
            build
            ~/.ccache
            ~/.cache/cmake
          key: ${{ runner.os }}-mila-${{ env.CUDA_VERSION }}-build-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-mila-${{ env.CUDA_VERSION }}-build-
            ${{ runner.os }}-mila-build-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build CI container image (from repository Dockerfile)
        uses: docker/build-push-action@v4
        with:
          context: Docker
          file: Docker/Dockerfile
          platforms: linux/amd64
          load: true
          tags: mila-ci:latest

      - name: Run full build + tests inside CI container
        env:
          CUDA_PATH: /usr/local/cuda-13.0
        run: |
          # Run the prepared image and execute the same steps your local devcontainer performs.
          docker run --rm \
            -e CUDA_VERSION=${{ env.CUDA_VERSION }} \
            -e CC=clang-19 -e CXX=clang++-19 \
            -v "${{ github.workspace }}":/workspace:cached \
            -v "${{ github.workspace }}/build":/workspace/build:cached \
            -v "${HOME}/.ccache":/root/.ccache \
            -w /workspace \
            mila-ci:latest \
            bash -eux -c "\
              export CUDA_PATH=/usr/local/cuda-13.0; \
              mkdir -p build; \
              cmake -B build -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_CXX_STANDARD=23 \
                -DCMAKE_CXX_STANDARD_REQUIRED=ON \
                -DCMAKE_CXX_EXTENSIONS=OFF \
                -DCMAKE_C_COMPILER=clang-19 \
                -DCMAKE_CXX_COMPILER=clang++-19 \
                -DCMAKE_CUDA_COMPILER=${CUDA_PATH}/bin/nvcc \
                -DCUDAToolkit_ROOT=${CUDA_PATH} \
                -DMILA_ENABLE_TESTING=ON; \
              cmake --build build --config Release -- -j \$(nproc); \
              cd build; \
              ctest --output-on-failure -j \$(nproc); \
              cmake --build build --target docs || true \
            "

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs
          path: build/docs/html

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ${{ github.workspace }}/build/docs/html
          branch: gh-pages
